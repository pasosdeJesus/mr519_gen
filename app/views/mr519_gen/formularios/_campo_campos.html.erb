<script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.11.0/jquery-ui.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.0/lodash.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/gridstack.js/0.4.0/gridstack.all.js"></script>
<%= f.input :id, as: :hidden %>
<div class="panel panel-default">
  <br/>
  <div class="panel-heading"><h4>Campos de tu formulario</h4></div>
  <br/>
  <div onmouseup="actualizaBloque(event)", data-bind ="component: {name: 'dashboard-grid', params: $data}">
  </div>
  <br/>
  <div class="panel-body">
    <div class="div-campos">
      <table border=1 width="100%">
        <thead>
          <tr>
            <th width="25%">Pregunta-Texto<br> Nombre interno</th>
            <th>Tipo</th>
            <th>Ayuda en el uso<br> Opciones</th>
            <th>Obligatorio</th>
            <th>Fila <br> Columna <br> Ancho</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody id="campos">
          <% if f.object.campo.count > 0 %>
            <%= f.simple_fields_for :campo, f.object.campo.
              order(:fila, :columna, :id) do |o| %>
              <%= render 'fila_campos', f:  o %>
            <% end %>
          <% end %>
        </tbody>
      </table>
      <div class="links">
        <%= link_to_add_association 'Agregar campo', f, :campo, {
          :"data-association-insertion-node" => "tbody#campos", 
          :"data-association-insertion-method" => "append", 
          partial: 'fila_campos',
          class: 'btn-primary',
          "data-bind": "click: addNewWidget",
          "data-ajax" => mr519_gen.new_campo_path,
          "data-ajaxdata" => "formulario_id" } %>
    </div> <!-- links -->
    </div> <!-- .div-campos -->
  </div><!-- panel-body -->
</div><!-- panel -->
<%= stylesheet_link_tag "grillaForm" %>
<script src="https://cdnjs.cloudflare.com/ajax/libs/AniJS/0.9.3/anijs-min.js"></script>
<script type="text/javascript">

  <% f.object = Mr519Gen::Campo.new() if !f.object %>    
  ko.components.register('dashboard-grid', {
    viewModel: {
      createViewModel: function (controller, componentInfo) {
        var ViewModel = function (controller, componentInfo) {
          var grid = null;
          this.widgets = controller.widgets;
          this.afterAddWidget = function (items) {
            if (grid == null) {
              grid = $(componentInfo.element).find('.grid-stack').gridstack({
                auto: false,
                resizable: { handles: 'e, w'}
              }).data('gridstack');
            }
            var item = items.find(function (i) { return i.nodeType == 1 });
            grid.addWidget(item);
            ko.utils.domNodeDisposal.addDisposeCallback(item, function () {
              grid.removeWidget(item);
            });
          };
        };
        return new ViewModel(controller, componentInfo);
      }
    },
    template:
    [
      '<div class="grid-stack" data-bind="foreach: {data: widgets, afterRender: afterAddWidget}">',
      '   <div class="grid-stack-item" data-bind="attr: {\'data-gs-x\': $data.x, \'data-gs-y\': $data.y, \'data-gs-width\': $data.width, \'data-gs-height\': $data.height,\'data-gs-min-width\': $data.minWidth, \'data-gs-auto-position\': $data.auto_position, \'data-gs-id\': $data.id}">',
      '       <div class="grid-stack-item-content"></div>',
      '   </div>',
      '</div> '
    ].join('')
  });
var coordenadas;
function cargarCoordenadas(id, coordenada){
  $('#formulario_campo_attributes_' + id + '_fila').attr('value', coordenada.x);
  $('#formulario_campo_attributes_' + id + '_columna').attr('value', coordenada.y);
  $('#formulario_campo_attributes_' + id + '_ancho').attr('value', coordenada.width);
};

function actualizaBloque(e){
  var bloqueClickeado;
  if (e.srcElement){
    tag = e.srcElement.parentElement;}
  else if (e.target){
    tag = e.target.parentElement;}
  bloqueClickeado = tag.getAttribute('data-gs-id');
  coordenadas = obteneruna(bloqueClickeado);
  cargarCoordenadas(bloqueClickeado, coordenadas);
};

function eliminaBloque(e, idBloque){
  if (e.srcElement){
    tag = e.srcElement.parentElement;}
  else if (e.target){
    tag = e.target.parentElement;}
  enlace = tag.firstElementChild;
  enlaceClickeado = enlace.firstElementChild.getAttribute('value');
  var bloqueAEliminar = $("[data-gs-id="+enlaceClickeado+"]");
  bloqueAEliminar.remove();
};
$('#campos').on('cocoon:after-insert', function(e, campo){
  var bloques = $("[data-gs-id=0]");
  var itemid = bloques.attr('data-gs-id');
  if (itemid == 0) {
    var ultimafila = e.target.lastElementChild;
    var ultimacolumna = ultimafila.lastElementChild;
    var elementoid = ultimacolumna.firstElementChild;
    var elid = elementoid.firstElementChild;
    bloques.attr('data-gs-id', elid.value);
    coordenadas = obteneruna(elid.value);
    cargarCoordenadas(elid.value, coordenadas);
  };
});
function obteneruna(identificador){
  var serializado = $('[data-gs-id='+identificador+']');
  var item = serializado.data('_gridstack_node');
  return {
    x: item.x + 1,
    y: item.y + 1,
    width: item.width
  };
};
$(function () {
  var Controller = function (widgets) {
    var self = this;
    this.widgets = ko.observableArray(widgets);
    this.addNewWidget = function () {
      this.widgets.push({
        x: 0,
        y: 0,
        width: Math.floor(1 + 3 * Math.random()),
        height: 1,
        minWidth: 2,
        auto_position: true,
        id: 0
      });
      return false;
    };

    $('#campos').on('cocoon:before-remove', function(e, campo){
      var enlacesEliminar = $("[class=eliminaCampos]")
    });
  };
  var widgets = [];
  var controller = new Controller(widgets);
  ko.applyBindings(controller);
});
</script>
